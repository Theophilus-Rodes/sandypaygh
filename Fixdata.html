<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Data Package</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
    }

    .header {
      text-align: center;
      background-color: #1e40af;
      color: white;
      padding: 20px 0;
      font-size: 24px;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      justify-content: space-around;
      background-color: #fff;
      padding: 15px 10px;
      border-bottom: 1px solid #ddd;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #555;
      border-radius: 6px;
      transition: 0.3s;
    }

    .tab:hover {
      background-color: #f1f5f9;
    }

    .tab.active {
      background-color: #f1a300;
      color: white;
    }

    .packages {
      padding: 20px;
    }

    .package-list {
      margin-top: 10px;
    }

    /* ----- Header row: DATA / COST / SELLING / STATUS / ACTION ----- */
    .package-table-header {
      display: none; /* will be shown when there is data */
      background: #e5edff;
      padding: 10px 15px;
      border-radius: 10px;
      margin-top: 15px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .package-item {
      background: #fff;
      margin-top: 8px;
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .col {
      display: flex;
      align-items: center;
    }

    .data-col {
      flex: 1.2;
      font-weight: 500;
    }

    .cost-col {
      flex: 1;
      color: #1f2937;
    }

    .sell-col {
      flex: 1;
    }

    .status-col {
      flex: 0.9;
      justify-content: flex-end;
    }

    .action-col {
      flex: 0.7;
      justify-content: flex-end;
    }

    .sell-input {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .status-select {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }

    .delete-btn {
      background-color: red;
      color: white;
      border: none;
      padding: 5px 8px;
      width: 32px;
      height: 32px;
      font-size: 14px;
      line-height: 1;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
    }

    .add-btn {
      background-color: #1e40af;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="header">ADD NEW DATA PACKAGES</div>

  <div class="tabs">
    <div class="tab active" data-network="MTN">MTN</div>
    <div class="tab" data-network="TELECEL">TELECEL</div>
    <div class="tab" data-network="airteltigo">AT</div>
  </div>

  <div class="packages">
    <h3 id="package-title">No packages added yet</h3>

    <!-- HEADER ROW -->
    <div class="package-table-header" id="package-table-header">
      <div class="col data-col">DATA</div>
      <div class="col cost-col">COST PRICE (GHS)</div>
      <div class="col sell-col">SELLING PRICE (GHS)</div>
      <div class="col status-col">STATUS</div>
      <div class="col action-col">ACTION</div>
    </div>

    <div class="package-list" id="package-list"></div>
  </div>

  <script>
    const API_BASE = "https://sandipay.co";

    let currentNetwork = 'MTN';
    let currentUserId = localStorage.getItem("userId") || '1';

    // will hold the last loaded packages so we can find them by admin_id later
    let packagesCache = [];

    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentNetwork = tab.dataset.network;
        fetchPackages();
      });
    });

    function fetchPackages() {
      fetch(`${API_BASE}/api/get-all-packages`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vendor_id: currentUserId, network: currentNetwork })
      })
      .then(res => res.json())
      .then(data => {
        const list   = document.getElementById("package-list");
        const title  = document.getElementById("package-title");
        const header = document.getElementById("package-table-header");

        list.innerHTML = "";

        if (!data || !data.length) {
          title.textContent = 'No packages added yet';
          header.style.display = "none";
          packagesCache = [];
          return;
        }

        title.textContent = `${currentNetwork} Packages`;
        header.style.display = "flex";

        // we expect:
        // admin_id  -> id of admin_data_packages
        // vendor_id -> id in data_packages (can be null if vendor has not added yet)
        // data_package, cost_price, selling_price, status
        packagesCache = data;

        data.forEach(pkg => {
          const adminId  = pkg.admin_id || pkg.id;        // fallback if you only return id
          const vendorId = pkg.vendor_id || null;
          const cost = pkg.cost_price !== undefined && pkg.cost_price !== null
            ? parseFloat(pkg.cost_price).toFixed(2)
            : (pkg.amount ? parseFloat(pkg.amount).toFixed(2) : "0.00");

          const selling = (pkg.selling_price !== undefined && pkg.selling_price !== null)
            ? parseFloat(pkg.selling_price).toFixed(2)
            : (pkg.amount ? parseFloat(pkg.amount).toFixed(2) : "");

          const status = pkg.status || "available";

          const item = document.createElement('div');
          item.className = 'package-item';

          item.innerHTML = `
            <div class="col data-col">${pkg.data_package}</div>
            <div class="col cost-col">GHS ${cost}</div>
            <div class="col sell-col">
              <input
                type="number"
                min="0"
                step="0.01"
                class="sell-input"
                id="sell-${adminId}"
                value="${selling}"
                placeholder="Enter selling price"
              />
            </div>
            <div class="col status-col">
              <select
                class="status-select"
                onchange="updateStatus(${vendorId ? vendorId : 'null'}, this.value)">
                <option value="available" ${status === "available" ? "selected" : ""}>Active</option>
                <option value="unavailable" ${status === "unavailable" ? "selected" : ""}>Inactive</option>
              </select>
            </div>
            <div class="col action-col">
              <button class="add-btn"
                onclick="savePackage(${adminId}, ${vendorId ? vendorId : 'null'})">
                ${vendorId ? "Update" : "Add"}
              </button>
              <button class="delete-btn"
                onclick="deletePackage(${vendorId ? vendorId : 'null'})">✖</button>
            </div>
          `;

          list.appendChild(item);
        });
      });
    }

    // Add new vendor package OR update existing one
    function savePackage(adminId, vendorId) {
      const input = document.getElementById(`sell-${adminId}`);
      if (!input) return;

      const amount = input.value.trim();
      if (!amount) {
        alert("Please enter a selling price first.");
        return;
      }

      // If vendor already has this package → update selling price
      if (vendorId) {
        fetch(`${API_BASE}/api/update-package-amount`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: vendorId, amount })
        })
        .then(() => {
          alert("Selling price updated");
          fetchPackages();
        })
        .catch(err => {
          console.error("Update amount error:", err);
          alert("Failed to update selling price");
        });
      } else {
        // vendor does NOT have this package yet → add new one
        const pkg = packagesCache.find(p => (p.admin_id || p.id) === adminId);
        if (!pkg) {
          alert("Package not found");
          return;
        }

        fetch(`${API_BASE}/api/add-package`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            network: currentNetwork,
            value: pkg.data_package,
            amount,
            status: "available",
            vendor_id: currentUserId
          })
        })
        .then(() => {
          alert("Package added");
          fetchPackages();
        })
        .catch(err => {
          console.error("Add package error:", err);
          alert("Failed to add package");
        });
      }
    }

    function deletePackage(vendorId) {
      // if no vendor record yet, nothing to delete
      if (!vendorId) {
        alert("This package has not been added for the vendor yet.");
        return;
      }

      if (!confirm("Are you sure you want to delete this package for this vendor?")) return;

      fetch(`${API_BASE}/api/delete-package`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: vendorId })
      })
      .then(res => res.text())
      .then(() => {
        alert("✅ Package deleted");
        fetchPackages();
      })
      .catch(err => {
        console.error("❌ Delete error:", err);
        alert("❌ Failed to delete package.");
      });
    }

    function updateStatus(vendorId, status) {
      // if vendor has not added this package yet, ignore status changes
      if (!vendorId) return;
      fetch(`${API_BASE}/api/update-status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: vendorId, status })
      })
      .then(() => fetchPackages())
      .catch(err => console.error("Status update error:", err));
    }

    window.onload = fetchPackages;
  </script>
</body>
</html>
