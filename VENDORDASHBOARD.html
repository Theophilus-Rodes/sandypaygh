<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sandypay Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f2f4f8;
      color: #333;
    }

    .topbar {
      background: #222a35;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-button {
      font-size: 24px;
      cursor: pointer;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 60px;
      left: 10px;
      background: #fff;
      border: 1px solid #ccc;
      width: 250px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px;
      color: #222;
      text-decoration: none;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .dropdown-menu a:hover {
      background: #f0f0f0;
    }

    .nested-orders {
      display: none;
      border-top: 1px solid #ddd;
      padding-left: 10px;
    }

    .section {
      padding: 20px;
    }

    .card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }


.modal {
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.5);
  display: flex; justify-content: center; align-items: center;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  min-width: 300px;
  position: relative;
}

.modal-content .close {
  position: absolute;
  right: 10px; top: 5px;
  font-size: 20px;
  cursor: pointer;
}




    .card h3 {
      margin: 0;
      font-size: 16px;
    }

    .card-icon {
      font-size: 22px;
      color: #4a90e2;
    }

    .highlight {
      background: #4a90e2;
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 18px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .buttons button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .wallet {
      background: #123456;
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }


    .modal-content select,
.modal-content input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

.btn-group button {
  font-size: 15px;
  font-weight: bold;
}

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .modal-content h3 {
      margin-top: 0;
    }

.modal-content select,
.modal-content input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
}

.btn-group button {
  font-size: 15px;
  font-weight: bold;
}

    .modal-content select,
    .modal-content button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 6px;
    }

    .modal-content select {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 6px;
}


    .modal-content .btn-group {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
    }


    .modal-content .btn-group button {
      width: 48%;
    }

    /* === Inline wallet metrics row === */
.wallet{
  background:#123456;
  color:#fff;
  padding:20px;
  border-radius:10px;
  margin-bottom:20px;
}

.wallet-row{
  display:flex;
  gap:12px;
  align-items:stretch;
  justify-content:space-between;
  flex-wrap:wrap;
}

.wallet-box{
  background:#1e3a5c;
  border:1px solid rgba(255,255,255,0.08);
  border-radius:10px;
  padding:12px 14px;
  min-width:220px;
  flex:1;
  display:flex;
  flex-direction:column;
  gap:6px;
  text-align:center;
}

.wallet-box.wallet-main{
  background:#2878d4; /* keeps main balance distinct */
}

.wallet-label{
  font-size:.85rem;
  opacity:.9;
}

.wallet-value{
  font-weight:700;
  font-size:1rem;
}

.wallet-value small{
  margin-left:6px;
  opacity:.9;
}

@media (max-width:900px){
  .wallet-box{ min-width:180px; }
}
@media (max-width:600px){
  .wallet-row{ flex-direction:column; }
  .wallet-box{ width:100%; }
}

  </style>
</head>
<body>

<div class="topbar">
  <div class="menu-button" onclick="toggleMenu()">&#9776;</div>
  <div id="vendorNameDisplay" style="font-size: 20px; font-weight: bold;"></div>

  <div style="width: 30px;"></div>
</div>


  <div class="dropdown-menu" id="menu">
    <a href="#" onclick="window.location.reload()">Summary</a>
    <a href="#" onclick="goToFixData()">Add Data Package</a>
    <a href="#" onclick="goToAfaOrders()">Afa Orders</a>
    <a href="#" onclick="goToTransactions()">Transactions</a>
    <a href="#" onclick="showAfaPriceDialog()">Set Afa Price</a>
    <a href="set_community.html">Set Community</a>
    <a href="#" onclick="goToSettings()">Settings</a>
    <a href="AdminOrdersDisplay.html">Admin Packages</a>
   <a id="purchaseSessionsLink" href="sessionboard.html">Purchase Sessions</a>
    <a href="#" onclick="handleLogout()">Logout</a>
  </div>

  <div class="section">
    <div class="buttons">
     <button style="background: #ffb400;" onclick="showWalletModal()">Load Wallet</button>
     <button onclick="showWithdrawModal()">Withdraw Balance</button>
      <button style="background: #3498db;" onclick="location.reload()">Refresh</button>

    </div>

    <div class="wallet">
  <div class="wallet-row">
    <!-- Main Balance -->
    <div class="wallet-box wallet-main">
      <div class="wallet-label">Main Wallet Balance</div>
      <div class="highlight">GHS <span id="mainBalance">0.00</span></div>
    </div>

    <!-- Sales (Selling) -->
    <div class="wallet-box">
      <div class="wallet-label">Sales (Selling)</div>
      <div class="wallet-value">GHS <span id="salesSelling">0.00</span></div>
    </div>

    <!-- Sales (Cost) -->
    <div class="wallet-box">
      <div class="wallet-label">Sales (Cost)</div>
      <div class="wallet-value">GHS <span id="salesCost">0.00</span></div>
    </div>

    <!-- USSD Sessions -->
    <div class="wallet-box">
      <div class="wallet-label">USSD Sessions</div>
      <div class="wallet-value">
        <span id="ussdHits">0</span> hits
        <small>
          
      <!-- USSD Sessions card -->
<div class="metric-card">
  <div class="metric-title">USSD Sessions</div>
  <div class="metric-value"><span id="ussdHits">0 hits</span></div>
  <div class="metric-sub"><span id="ussdRemain">s: 0000</span></div>
</div>

        </small>
      </div>
    </div>
  </div>
</div>


      
    </div>



    <div class="card"><h3>Total Customers</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Total Transactions</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Pending Orders - MTN</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Pending Orders - AT</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Pending Orders - TELECEL</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Pending Orders - AFA</h3><div class="card-icon">0</div></div>
    <div class="card"><h3>Completed Orders - AFA</h3><div class="card-icon">0</div></div>
  </div>

  <!-- Modal Dialog -->
  <div class="modal" id="sendOrdersModal">
    <div class="modal-content">
      <h3>Select Network</h3>
      <select id="networkSelect">
        <option value="MTN">MTN</option>
        <option value="TELECEL">TELECEL</option>
        <option value="AIRTELTIGO">AT</option>
      </select>
      <div id="confirmText" style="margin-top: 15px;"></div>
      <div class="btn-group">
        <button onclick="sendOrdersToAdmin()">Yes</button>
        <button onclick="closeSendOrdersDialog()" style="background: #ccc;">No</button>
      </div>
    </div>
  </div>

  <script>
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }

    

   

    function closeSendOrdersDialog() {
      document.getElementById("sendOrdersModal").style.display = "none";
    }



     function confirmSendToAdmin() {
      const network = document.getElementById("networkSelect").value;
      document.getElementById("confirmText").innerText = `Are you sure you want to send ${network} orders to the admin?`;
    }


    function goToFixData() {
      const userId = localStorage.getItem("userId");
      if (userId) {
        window.location.href = `Fixdata.html?id=${userId}`;
      } else {
        alert("User ID not found. Please log in again.");
      }
    }
  </script>

  <script>
 function handleLogout() {
  document.getElementById("logoutConfirmModal").style.display = "flex";
}

function confirmLogout() {
  localStorage.clear();
  window.location.href = "index.html";
}

function cancelLogout() {
  document.getElementById("logoutConfirmModal").style.display = "none";
}
</script>

<script>
  function goToTransactions() {
    const vendorId = new URLSearchParams(window.location.search).get("id");
    if (!vendorId) return alert("Vendor ID missing");
    window.location.href = `transaction.html?vendor_id=${vendorId}`;
  }
</script>











<script>
  function goToMtnOrders() {
    const vendorId = localStorage.getItem("userId"); // or "vendorId" if you're storing that name
    if (!vendorId) {
      alert("Vendor ID not found.");
      return;
    }
    window.location.href = `Mtn_orders.html?vendor_id=${vendorId}`;
  }
</script>
<script>
  function goToTelecel() {
    const vendorId = localStorage.getItem("userId"); // or "vendorId" if you're storing that name
    if (!vendorId) {
      alert("Vendor ID not found.");
      return;
    }
    window.location.href = `Telecel_orders.html?vendor_id=${vendorId}`;
  }
</script>

<script>
  function goToairteltigo() {
    const vendorId = localStorage.getItem("userId"); // or "vendorId" if you're storing that name
    if (!vendorId) {
      alert("Vendor ID not found.");
      return;
    }
    window.location.href = `airteltigo_orders.html?vendor_id=${vendorId}`;
  }
</script>






<script>
function sendOrdersToAdmin() {
  const vendorId = localStorage.getItem("userId");
  const network = document.getElementById("networkSelect").value.toLowerCase();

  if (!vendorId || !network) {
    alert("Missing vendor ID or network.");
    return;
  }

  fetch("https://sandipay.co/api/send-orders-to-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId, network })
  })
  .then(async res => {
    const msg = await res.text();
    if (!res.ok) {
      alert("‚ùå " + msg);
      throw new Error(msg); // prevent moving forward
    }
    alert("‚úÖ " + msg);
    document.getElementById("sendOrdersModal").style.display = "none";
  })
  .catch(err => {
    console.error("Frontend Error:", err);
    alert("Failed to send orders. Please try again.");
  });
}
</script>



<script>
function confirmWalletLoad() {
  const network = document.getElementById("walletNetwork").value.toLowerCase(); // ‚úÖ fixed
  const momo = document.getElementById("walletMomo").value.trim();
  const amount = parseFloat(document.getElementById("walletAmount").value);
  const vendorId = localStorage.getItem("userId");

  if (!network || !momo || !amount || !vendorId) {
    alert("Please complete all fields.");
    return;
  }

  fetch("https://sandipay.co/api/load-wallet-the-teller", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ momo, amount, vendor_id: vendorId, network })
  })
  .then(res => res.text())
  .then(msg => {
    alert(msg);
    closeWalletModal();
    fetchWalletBalance();
  })
  .catch(err => {
    console.error("Wallet load error:", err);
    alert("Failed to load wallet.");
  });
}




</script>

<script>
  function showWithdrawModal() {
    document.getElementById("withdrawModal").style.display = "flex";
  }

  function closeWithdrawModal() {
    document.getElementById("withdrawModal").style.display = "none";
  }
</script>



<script>
  

  function showWalletModal() {
  document.getElementById("walletModal").style.display = "flex";
}

function closeWalletModal() {
  document.getElementById("walletModal").style.display = "none";
}



</script>
<script>
  
  function fetchWalletBalance() {
  const vendorId = localStorage.getItem("userId");
  if (!vendorId) return;

  fetch("https://sandipay.co/api/wallet-balance", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId })
  })
  .then(res => res.json())
  .then(data => {
    if (data.balance !== undefined) {
      document.querySelector(".highlight").innerText = `GHS ${parseFloat(data.balance).toFixed(2)}`;
    }
  })
  .catch(err => {
    console.error("Failed to fetch wallet balance", err);
  });
}


</script>




<script>
function showAfaPriceDialog() {
  fetch('https://sandipay.co/api/afa-price/admin')
    .then(response => response.json())
    .then(data => {
      document.getElementById('adminPrice').innerText = "Admin Price: GHS " + data.adminPrice;
      document.getElementById('afaPriceDialog').style.display = 'flex';
    })
    .catch(() => {
      document.getElementById('adminPrice').innerText = "Failed to load admin price.";
    });
}

function closeAfaPriceDialog() {
  document.getElementById('afaPriceDialog').style.display = 'none';
}

function submitVendorPrice() {
  const price = document.getElementById('vendorPrice').value;
  const user_id = localStorage.getItem("userId"); // ‚úÖ fixed from "user_id" to "userId"

  if (!price || !user_id) return alert("Missing price or user ID");

  fetch('https://sandipay.co/api/afa-price/vendor', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id, price })
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    closeAfaPriceDialog();
  })
  .catch(() => alert("Failed to save price."));
}
</script>







<script>
  


function closeDeliveredDialog() {
  document.getElementById("deliveredModal").style.display = "none";
}

</script>




</script>

<script>
function loadWalletBalance() {
  const vendorId = localStorage.getItem("userId");
  if (!vendorId) return;

  fetch("https://sandipay.co/api/get-wallet-balance", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId })
  })
  .then(res => res.json())
  .then(data => {
    document.querySelector(".highlight").innerText = "GHS " + parseFloat(data.balance).toFixed(2);
  })
  .catch(err => {
    console.error("Error loading wallet:", err);
  });
}
</script>
<script>
window.onload = function () {
  const vendorId = localStorage.getItem("userId");
  const username = localStorage.getItem("username"); // ‚úÖ Add this

  if (username) {
    document.getElementById("vendorNameDisplay").innerText = username;
  }
  if (!vendorId) return;

  // ‚úÖ Fetch wallet balance
  fetch("https://sandipay.co/api/wallet-balance", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId })
  })
  .then(res => res.json())
  .then(data => {
    document.querySelector(".highlight").innerText = `GHS ${parseFloat(data.balance || 0).toFixed(2)}`;
  })
  .catch(err => {
    console.error("Failed to fetch wallet balance", err);
  });

  // ‚úÖ Fetch dashboard metrics
  fetch("https://sandipay.co/api/dashboard-metrics", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId })
  })
  .then(res => res.json())
  .then(data => {
    document.querySelectorAll(".card")[0].querySelector(".card-icon").innerText = data.total_customers;
    document.querySelectorAll(".card")[1].querySelector(".card-icon").innerText = data.total_transactions;
    document.querySelectorAll(".card")[2].querySelector(".card-icon").innerText = data.pending_mtn;
    document.querySelectorAll(".card")[3].querySelector(".card-icon").innerText = data.pending_at;
    document.querySelectorAll(".card")[4].querySelector(".card-icon").innerText = data.pending_telecel;
    document.querySelectorAll(".card")[5].querySelector(".card-icon").innerText = data.pending_afa;
    document.querySelectorAll(".card")[6].querySelector(".card-icon").innerText = data.completed_afa;
  })
  .catch(err => {
    console.error("Failed to load dashboard data:", err);
  });
};


</script>




<script>
  function goToSettings() {
    const vendorId = new URLSearchParams(window.location.search).get("id");
    if (!vendorId) return alert("Vendor ID missing in URL");
    window.location.href = `settings.html?vendor_id=${vendorId}`;
  }
</script>


<script>
 function submitWithdrawal() {
  const momo = document.getElementById("momoInput").value.trim();
  const amount = document.getElementById("amountInput").value.trim();
  const network = document.getElementById("networkInput").value;
  const vendorId = localStorage.getItem("userId");

  if (!momo || !amount || !vendorId || !network) {
    return alert("Please fill all fields.");
  }

  // ‚úÖ Send request to backend 
  fetch("https://sandipay.co/api/request-withdrawal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ vendor_id: vendorId, momo_number: momo, amount, network })
  })
  .then(res => res.text())
  .then(msg => {
  alert(msg); // show exactly what server sends
  closeWithdrawModal();
})
  .catch(err => {
    console.error("Withdraw request error:", err);
    alert("‚ùå Failed to send withdrawal request.");
  });
}


</script>

<script>
  function updateTopLine(salesSelling, salesCost, ussdHits){
    const to2 = n => Number(n||0).toFixed(2);
    const hits = Number(ussdHits||0);
    const cost = hits * 0.02;

    document.getElementById('salesSelling').textContent = to2(salesSelling);
    document.getElementById('salesCost').textContent    = to2(salesCost);
    document.getElementById('ussdHits').textContent     = hits.toLocaleString();
    document.getElementById('ussdCost').textContent     = to2(cost);
  }

  // Example only ‚Äî replace with your real API values when ready:
  // updateTopLine(1234.5, 980.0, 356);
</script>



<!-- Load Wallet Modal -->
<!-- Load Wallet Modal (Improved Design) -->
<div id="walletModal" class="modal">
  <div class="modal-content" style="padding: 25px; max-width: 380px;">
    <h3 style="color: #0a0f5a; margin-bottom: 15px;">üí∞ Load Wallet</h3>

    <select id="walletNetwork" style="margin-bottom: 15px;">
      <option value="">-- Select Network --</option>
      <option value="mtn">MTN</option>
      <option value="airteltigo">AirtelTigo</option>
      <option value="telecel">Telecel</option>
    </select>

    <input type="text" id="walletMomo" placeholder="Enter MoMo Number" style="margin-bottom: 12px;" />
    <input type="number" id="walletAmount" placeholder="Enter Amount (GHS)" style="margin-bottom: 20px;" />

    <div class="btn-group">
      <button class="confirm" style="background-color: #0a0f5a; color: white;" onclick="confirmWalletLoad()">Confirm</button>
      <button class="cancel" style="background-color: #ccc;" onclick="closeWalletModal()">Cancel</button>
    </div>
  </div>
</div>






<!-- ‚úÖ Delivered Orders Modal -->
<div id="afaPriceDialog" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeAfaPriceDialog()">&times;</span>
    <h3>Set AFA Price</h3>
    <p id="adminPrice">Loading admin price...</p>
    <label for="vendorPrice">Your Price (GHS):</label>
    <input type="number" id="vendorPrice" placeholder="Enter your price" />
    <button onclick="submitVendorPrice()">Save</button>
  </div>
</div>



<div class="modal" id="deliveredModal">
  <div class="modal-content">
    <h3>Delivered Orders</h3>
    <div id="deliveredOrdersList" style="max-height: 300px; overflow-y: auto; font-size: 14px;"></div>
    <div class="btn-group">
      <button onclick="closeDeliveredDialog()">Close</button>
    </div>
  </div>
</div>

<!-- Withdrawal Modal -->
<!-- Withdrawal Modal (Improved Design) -->
<div id="withdrawModal" class="modal">
  <div class="modal-content" style="padding: 25px; max-width: 380px;">
    <h3 style="color: #0a0f5a; margin-bottom: 15px;">üí∏ Withdraw Funds</h3>

    <select id="networkInput" style="margin-bottom: 15px;">
      <option value="">-- Select Network --</option>
      <option value="mtn">MTN</option>
      <option value="airteltigo">AirtelTigo</option>
      <option value="telecel">Telecel</option>
    </select>

    <input type="text" id="momoInput" placeholder="Enter MoMo Number" style="margin-bottom: 12px;" />
    <input type="number" id="amountInput" placeholder="Amount to Withdraw (GHS)" style="margin-bottom: 20px;" />

    <div class="btn-group">
      <button class="confirm" style="background-color: #0a0f5a; color: white;" onclick="submitWithdrawal()">Submit</button>
      <button class="cancel" style="background-color: #ccc;" onclick="closeWithdrawModal()">Cancel</button>
    </div>
  </div>
</div>



<!-- ‚úÖ Logout Confirmation Modal -->
<div class="modal" id="logoutConfirmModal">
  <div class="modal-content">
    <h3>Are you sure you want to logout?</h3>
    <div class="btn-group">
      <button onclick="confirmLogout()">Yes</button>
      <button onclick="cancelLogout()" style="background: #ccc;">No</button>
    </div>
  </div>
</div>

<script>
  // Pass vendor id through to the new page
  (function () {
    const params = new URLSearchParams(location.search);
    const vendorId = params.get("id");
    const link = document.getElementById("purchaseSessionsLink");
    if (link && vendorId) link.href = `sessionboard.html?id=${encodeURIComponent(vendorId)}`;
  })();
</script>

<script>
(async function loadUssdStats(){
  try {
    const params = new URLSearchParams(location.search);
    const vendor_id = params.get("id"); // your dashboard already uses ?id=5
    if (!vendor_id) return;

    const res = await fetch(`/api/vendor/ussd-stats?vendor_id=${encodeURIComponent(vendor_id)}`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const { used_hits = 0, remaining_hits = 0 } = await res.json();

    const hitsEl = document.getElementById("ussdHits");
    const remEl  = document.getElementById("ussdRemain");
    if (hitsEl) hitsEl.textContent = `${used_hits} hits`;
    if (remEl)  remEl.textContent  = `s: ${remaining_hits}`;
  } catch (e) {
    console.warn("Failed to load USSD stats:", e.message);
  }
})();
</script>



</body>
</html>
