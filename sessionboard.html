<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Purchase Sessions</title>
<link rel="stylesheet" href="style.css" />
<style>
  body{background:#f5f7fb;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:720px;margin:32px auto;padding:20px}
  .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(10,15,90,.08);padding:20px;margin-bottom:16px}
  h1{font-size:22px;margin-bottom:12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:#6f7b95;font-size:14px;margin-bottom:12px}
  label{display:block;font-size:14px;margin:10px 0 6px}
  input,select,button{width:100%;padding:12px;border:1px solid #e4e8f1;border-radius:10px;font-size:14px}
  button{border:0;background:#0a0f5a;color:#fff;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .seg{display:flex;gap:10px;margin:8px 0 14px}
  .seg > label{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #e4e8f1;border-radius:10px;cursor:pointer}
  .hidden{display:none}
  .msg{margin-top:12px;font-size:14px}
  .ok{color:#106b21}
  .err{color:#b00020}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Purchase Sessions</h1>
      <p class="muted">Choose a funding source and enter the amount you want to purchase.</p>

      <div class="seg">
        <label><input type="radio" name="source" value="wallet" checked /> Main Account</label>
        <label><input type="radio" name="source" value="momo" /> MoMo</label>
      </div>

      <!-- Main Account form -->
      <div id="walletForm" class="">
        <label>Amount (GHS)</label>
        <input type="number" id="walletAmount" min="1" step="1" placeholder="e.g. 50" />
        <label>Hits (auto)</label>
        <input type="text" id="walletHits" readonly placeholder="0 hits" />
        <button id="walletBtn">Purchase from Main Account</button>
        <div id="walletMsg" class="msg"></div>
      </div>

      <!-- MoMo form -->
      <div id="momoForm" class="hidden">
        <label>Amount (GHS)</label>
        <input type="number" id="momoAmount" min="1" step="1" placeholder="e.g. 50" />

        <label>MoMo Number</label>
        <input type="tel" id="momoNumber" placeholder="e.g. 024XXXXXXX" />

        <label>Hits (auto)</label>
        <input type="text" id="momoHits" readonly placeholder="0 hits" />

        <label>Network</label>
        <select id="momoNetwork">
          <option value="">-- Select Network --</option>
          <option value="mtn">MTN</option>
          <option value="airteltigo">AirtelTigo</option>
          <option value="telecel">Telecel</option>
        </select>

        <button id="momoBtn">Purchase via MoMo</button>

        <!-- OTP STEP (for Moolre verification) -->
        <div id="otpSection" class="hidden">
          <label>Enter OTP sent to your phone</label>
          <input type="text" id="moolreOtp" placeholder="Code from SMS" />
          <button id="otpBtn">Verify & Complete Payment</button>
        </div>

        <div id="momoMsg" class="msg"></div>
      </div>
    </div>
  </div>

<script>
  // --- URL params ---
  const params = new URLSearchParams(location.search);
  const vendorId = params.get("id");

  // --- Elements ---
  const walletForm = document.getElementById("walletForm");
  const momoForm   = document.getElementById("momoForm");

  const walletAmtEl  = document.getElementById("walletAmount");
  const walletHitsEl = document.getElementById("walletHits");
  const walletBtn    = document.getElementById("walletBtn");
  const walletMsg    = document.getElementById("walletMsg");

  const momoAmtEl    = document.getElementById("momoAmount");
  const momoHitsEl   = document.getElementById("momoHits");
  const momoNumberEl = document.getElementById("momoNumber");
  const momoNetEl    = document.getElementById("momoNetwork");
  const momoBtn      = document.getElementById("momoBtn");
  const momoMsg      = document.getElementById("momoMsg");

  const otpSection   = document.getElementById("otpSection");
  const otpInput     = document.getElementById("moolreOtp");
  const otpBtn       = document.getElementById("otpBtn");

  // will hold the Moolre reference from INIT call
  let currentMoolreRef = null;

  // --- Toggle source (Main Account vs MoMo) ---
  document.querySelectorAll('input[name="source"]').forEach(r => {
    r.addEventListener("change", () => {
      const val = document.querySelector('input[name="source"]:checked').value;
      walletForm.classList.toggle("hidden", val !== "wallet");
      momoForm.classList.toggle("hidden", val !== "momo");
    });
  });

  // --- API base ---
  const API_BASE = "https://sandipay.co/api";

  // --- Hits calculator ---
  const HIT_COST = 0.02; // GHS per hit (1 GHS = 50 hits)

  function calcHitsFromAmount(amt) {
    const a = Number(amt);
    if (!a || a <= 0) return 0;
    return Math.floor(a / HIT_COST);
  }

  function formatHits(n) {
    return `${n} / hits`;
  }

  function updateWalletHits() {
    if (!walletHitsEl) return;
    const hits = calcHitsFromAmount(walletAmtEl.value);
    walletHitsEl.value = formatHits(hits);
  }

  function updateMomoHits() {
    if (!momoHitsEl) return;
    const hits = calcHitsFromAmount(momoAmtEl.value);
    momoHitsEl.value = formatHits(hits);
  }

  // Bind live updates
  if (walletAmtEl) walletAmtEl.addEventListener("input", updateWalletHits);
  if (momoAmtEl)   momoAmtEl.addEventListener("input", updateMomoHits);

  // Initialize on load
  updateWalletHits();
  updateMomoHits();

  // ---------- helper to safely read JSON ONCE ----------
  async function safeJson(res) {
    try {
      const data = await res.json();
      return { data, ok: true };
    } catch (e) {
      // do NOT call res.text() here – the stream is already used
      return {
        data: { error: "Invalid response from server" },
        ok: false,
        parseError: e.message
      };
    }
  }

  // --- Wallet purchase (Main Account) ---
  walletBtn?.addEventListener("click", async () => {
    const amount = Number(walletAmtEl.value);
    walletMsg.textContent = "";

    if (!vendorId)   return walletMsg.innerHTML = '<span class="err">Missing vendor id.</span>';
    if (!amount || amount < 1) return walletMsg.innerHTML = '<span class="err">Enter a valid amount.</span>';

    const computed_hits = calcHitsFromAmount(amount);

    try {
      walletBtn.disabled = true;
      const res = await fetch(`${API_BASE}/sessions/purchase`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vendor_id: vendorId,
          amount,
          computed_hits
        })
      });

      const { data } = await safeJson(res);

      if (res.ok) {
        walletMsg.innerHTML =
          `<span class="ok">Saved! Ref: ${data.reference || data.id}. Credited: ${data.hits ?? computed_hits} hits.</span>`;
      } else {
        walletMsg.innerHTML =
          `<span class="err">${data.error || "Could not save."}</span>`;
      }
    } catch (e) {
      walletMsg.innerHTML = `<span class="err">${e.message}</span>`;
    } finally {
      walletBtn.disabled = false;
    }
  });

  // --- MoMo purchase (Moolre INIT) ---
  momoBtn?.addEventListener("click", async () => {
    const amount      = Number(momoAmtEl.value);
    const momo_number = momoNumberEl.value.trim();
    const network     = momoNetEl.value;

    momoMsg.textContent = "";
    currentMoolreRef = null;
    otpSection.classList.add("hidden");

    if (!vendorId)             return momoMsg.innerHTML = '<span class="err">Missing vendor id.</span>';
    if (!amount || amount < 1) return momoMsg.innerHTML = '<span class="err">Enter a valid amount.</span>';
    if (!momo_number)          return momoMsg.innerHTML = '<span class="err">Enter a MoMo number.</span>';
    if (!network)              return momoMsg.innerHTML = '<span class="err">Select a network.</span>';

    const computed_hits = calcHitsFromAmount(amount);

    try {
      momoBtn.disabled = true;
      momoMsg.innerHTML = 'Requesting payment… please wait. You will receive an OTP SMS from Moolre.';

      const res = await fetch(`${API_BASE}/sessions/purchase-momo`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vendor_id: vendorId,
          amount,
          momo_number,
          network,
          computed_hits
        })
      });

      const { data } = await safeJson(res);

      if (res.ok && data.ok !== false) {
        currentMoolreRef = data.reference;
        momoMsg.innerHTML =
          `<span class="ok">
            Payment request sent (Ref: ${data.reference}).<br/>
            An OTP has been sent to your phone. Complete the verification on your phone, 
            then enter the code below and tap "Verify & Complete Payment".
          </span>`;
        otpInput.value = "";
        otpSection.classList.remove("hidden");
      } else {
        currentMoolreRef = null;
        otpSection.classList.add("hidden");
        momoMsg.innerHTML =
          `<span class="err">${data.error || "Payment failed to start."}</span>`;
      }
    } catch (e) {
      currentMoolreRef = null;
      otpSection.classList.add("hidden");
      momoMsg.innerHTML = `<span class="err">${e.message}</span>`;
    } finally {
      momoBtn.disabled = false;
    }
  });

  // --- OTP VERIFY STEP (Moolre status check) ---
  otpBtn?.addEventListener("click", async () => {
    const amount      = Number(momoAmtEl.value);
    const momo_number = momoNumberEl.value.trim();
    const network     = momoNetEl.value;
    const otp         = otpInput.value.trim(); // for UX/logging

    if (!currentMoolreRef) {
      return momoMsg.innerHTML = '<span class="err">No active payment to verify. Start again.</span>';
    }
    if (!otp) {
      return momoMsg.innerHTML = '<span class="err">Enter the OTP code sent to your phone.</span>';
    }

    const computed_hits = calcHitsFromAmount(amount);

    try {
      otpBtn.disabled = true;
      momoMsg.innerHTML = 'Verifying payment, please wait…';

      const res = await fetch(`${API_BASE}/sessions/confirm-momo`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          vendor_id: vendorId,
          reference: currentMoolreRef,
          amount,
          momo_number,
          network,
          computed_hits,
          otp
        })
      });

      const { data } = await safeJson(res);

      if (res.ok) {
        momoMsg.innerHTML =
          `<span class="ok">
            Payment approved! Ref: ${data.reference}. 
            Credited: ${data.hits ?? computed_hits} hits.
          </span>`;
      } else {
        momoMsg.innerHTML =
          `<span class="err">${data.error || "Payment not approved yet. Try again after completing OTP."}</span>`;
      }
    } catch (e) {
      momoMsg.innerHTML = `<span class="err">${e.message}</span>`;
    } finally {
      otpBtn.disabled = false;
    }
  });
</script>

</body>
</html>
